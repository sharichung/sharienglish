<!doctype html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- add Font Awesome (if not already present) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <title>éŠæˆ²å•Ÿå‹•é é¢ - æ•™å­¸ç®¡ç†ç³»çµ±</title>
    <style>
        body {
            box-sizing: border-box;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #FDFBF7 0%, #F0F8FF 100%);
            color: #2C3E50;
            line-height: 1.6;
            height: 100%;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* é ‚éƒ¨è³‡è¨Š Bar */
        .top-info-bar {
            background: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(167, 199, 231, 0.15);
            border-bottom: 2px solid #A7C7E7;
            height: 50px;
            position: relative;
            z-index: 10;
        }

        .teacher-info {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            color: #2C3E50;
        }

        .teacher-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #A7C7E7, #FFF5B2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .teacher-avatar:hover {
            transform: scale(1.1);
        }

        .student-display {
            font-size: 0.95rem;
        }

        .switch-student-btn {
            background: #A7C7E7;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .switch-student-btn:hover {
            background: #8BB5D9;
            transform: translateY(-1px);
        }

        .group-tip {
            position: absolute;
            top: 100%;
            left: 20px;
            right: 20px;
            background: #FFF5B2;
            color: #2C3E50;
            padding: 8px 12px;
            border-radius: 0 0 10px 10px;
            font-size: 0.8rem;
            text-align: center;
            box-shadow: 0 2px 8px rgba(255, 245, 178, 0.3);
            display: none;
            animation: slideDown 0.3s ease;
        }

        .group-tip.show {
            display: block;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-10px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* ä¸»è¦éŠæˆ²å€åŸŸ */
        .game-section {
            flex: 1;
            position: relative;
            margin: 15px;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(167, 199, 231, 0.2);
            background: white;
            display: flex;
            flex-direction: column;
        }

        .game-info-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            z-index: 5;
            border-bottom: 1px solid rgba(167, 199, 231, 0.3);
        }

        .game-header {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .game-cover {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: linear-gradient(135deg, #FFF5B2, #A7C7E7);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }

        .game-details {
            flex: 1;
            min-width: 0;
        }

        .game-title {
            font-size: 1.2rem;
            color: #2C3E50;
            margin-bottom: 6px;
            font-weight: 600;
        }

        .game-tags {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .tag {
            background: #A7C7E7;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .tag.level {
            background: #FFF5B2;
            color: #2C3E50;
        }

        .game-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .fullscreen-btn {
            background: rgba(167, 199, 231, 0.2);
            color: #2C3E50;
            border: none;
            padding: 6px 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2rem;
            font-weight: 500;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .fullscreen-btn:hover {
            background: rgba(167, 199, 231, 0.4);
            transform: scale(1.05);
        }

        .game-status {
            background: rgba(46, 204, 113, 0.2);
            color: #27AE60;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .game-container {
            flex: 1;
            background: #F8F9FA;
            position: relative;
            margin-top: 80px;
        }

        .game-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* åº•éƒ¨æµ®å‹•å·¥å…·åˆ— */
        .bottom-toolbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 12px 20px;
            box-shadow: 0 -4px 16px rgba(167, 199, 231, 0.2);
            border-top: 2px solid #A7C7E7;
            z-index: 20;
            height: 56px;
            text-align: center;
        }

        .toolbar-content {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr auto auto auto;
            gap: 12px;
            align-items: center;
        }

        .game-switcher {
            position: relative;
        }

        .game-select {
            width: 100%;
            min-width: 180px;
            padding: 8px 12px;
            border: 2px solid #A7C7E7;
            border-radius: 20px;
            background: white;
            font-size: 0.85rem;
            cursor: pointer;
        }

        .toolbar-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .btn-complete {
            background: #27AE60;
            color: white;
        }

        .btn-complete:hover {
            background: #229954;
            transform: translateY(-2px);
        }

        .btn-ai {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #2C3E50;
            position: relative;
            overflow: hidden;
        }

        .btn-ai:hover {
            transform: translateY(-2px);
        }

        .btn-ai::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transform: rotate(45deg);
            animation: shine 2s infinite;
        }

        @keyframes shine {
            0% {
                transform: translateX(-100%) translateY(-100%) rotate(45deg);
            }

            50% {
                transform: translateX(100%) translateY(100%) rotate(45deg);
            }

            100% {
                transform: translateX(-100%) translateY(-100%) rotate(45deg);
            }
        }

        .btn-end {
            background: #E74C3C;
            color: white;
        }

        .btn-end:hover {
            background: #C0392B;
            transform: translateY(-2px);
        }

        /* æ”¶åˆå€åŸŸ */
        .collapsible-sections {
            position: fixed;
            top: 70px;
            right: 15px;
            z-index: 15;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 280px;
        }

        .collapsible-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 16px rgba(167, 199, 231, 0.3);
            border: 2px solid #A7C7E7;
            overflow: hidden;
        }

        .card-header {
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s ease;
            background: rgba(167, 199, 231, 0.1);
        }

        .card-header:hover {
            background: rgba(167, 199, 231, 0.2);
        }

        .card-title {
            font-weight: 600;
            color: #2C3E50;
            font-size: 0.9rem;
        }

        .expand-icon {
            transition: transform 0.2s ease;
            color: #7F8C8D;
        }

        .expand-icon.rotated {
            transform: rotate(180deg);
        }

        .card-content {
            max-height: 0;
            overflow: auto;
            transition: max-height 0.2s ease;
        }

        .card-content.expanded {
            max-height: 300px;
        }

        .card-inner {
            padding: 15px;
        }

        .bookmarked-games {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .game-bookmark {
            background: #F8F9FA;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 3px solid #A7C7E7;
        }

        .game-bookmark:hover {
            background: #E8F4FD;
            transform: translateX(3px);
        }

        .bookmark-title {
            font-weight: 600;
            color: #2C3E50;
            font-size: 0.85rem;
            margin-bottom: 2px;
        }

        .bookmark-meta {
            font-size: 0.75rem;
            color: #7F8C8D;
        }

        .add-game-btn {
            background: #A7C7E7;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            width: 100%;
        }

        .add-game-btn:hover {
            background: #8BB5D9;
            transform: translateY(-1px);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 99999 !important;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 25px;
            border-radius: 20px;
            width: 90%;
            max-width: 450px;
            max-height: 80%;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #F8F9FA;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2C3E50;
        }

        .close {
            color: #aaa;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .close:hover {
            color: #000;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #2C3E50;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #A7C7E7;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: border-color 0.2s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #8BB5D9;
        }

        .radio-group {
            display: flex;
            gap: 15px;
            margin-top: 8px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn-modal {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .btn-secondary {
            background: #FFF5B2;
            color: #2C3E50;
        }

        .btn-secondary:hover {
            background: #FFE082;
            transform: translateY(-1px);
        }

        .btn-primary {
            background: #A7C7E7;
            color: white;
        }

        .btn-primary:hover {
            background: #8BB5D9;
            transform: translateY(-1px);
        }

        /* Premium å‡ç´šå¡ç‰‡ */
        .premium-float {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #2C3E50;
            padding: 15px 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(255, 215, 0, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 25;
            max-width: 250px;
            display: none;
        }

        .premium-float.show {
            display: block;
            animation: bounceIn 0.5s ease;
        }

        @keyframes bounceIn {
            0% {
                transform: scale(0.3) translateY(20px);
                opacity: 0;
            }

            50% {
                transform: scale(1.05);
            }

            70% {
                transform: scale(0.9);
            }

            100% {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }

        .premium-float:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 40px rgba(255, 215, 0, 0.4);
        }

        .premium-title {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .premium-desc {
            font-size: 0.75rem;
            opacity: 0.8;
        }

        /* Toast é€šçŸ¥ */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #2C3E50;
            color: white;
            padding: 12px 18px;
            border-radius: 8px;
            z-index: 10000;
            font-weight: 500;
            font-size: 0.9rem;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .container {
                margin: 0;
            }

            .game-section {
                margin: 10px;
                border-radius: 15px;
            }

            .collapsible-sections {
                position: static;
                margin: 10px;
                max-width: none;
            }

            .toolbar-content {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .game-select {
                min-width: auto;
            }

            .bottom-toolbar {
                height: auto;
                padding: 10px;
            }

            .game-container {
                margin-top: 70px;
            }

            .premium-float {
                bottom: 120px;
                right: 10px;
                left: 10px;
                max-width: none;
            }

            .teacher-info {
                font-size: 0.85rem;
            }

            .game-header {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
        }

        @media (max-width: 480px) {
            .top-info-bar {
                padding: 8px 15px;
                flex-direction: column;
                height: auto;
                gap: 8px;
            }

            .game-info-overlay {
                padding: 10px 15px;
            }

            .game-container {
                margin-top: 60px;
            }

            .modal-content {
                margin: 10% auto;
                padding: 20px;
            }

            .toolbar-btn {
                padding: 6px 12px;
                font-size: 0.75rem;
            }
        }

        /* å¯åŠæ€§æ”¹å–„ */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        button:focus,
        select:focus,
        input:focus {
            outline: 2px solid #A7C7E7;
            outline-offset: 2px;
        }

        /* Dropdown navigation style (replace/augment collapsible styles) */
        .dropdown-nav {
            position: relative;
            width: 100%;
            max-width: 280px;
        }

        .dropdown-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: rgba(167, 199, 231, 0.1);
            border-radius: 10px;
            cursor: pointer;
            user-select: none;
        }

        .dropdown-toggle:focus {
            outline: 2px solid #8BB5D9;
        }

        .dropdown-title {
            font-weight: 600;
            color: #2C3E50;
            font-size: 0.9rem;
        }

        .dropdown-icon {
            transition: transform .2s ease;
            color: #7F8C8D;
            font-size: x-small;
        }

        .dropdown-menu {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            width: 320px;
            max-height: 360px;
            overflow: auto;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(167, 199, 231, 0.25);
            border: 2px solid #A7C7E7;
            display: none;
            z-index: 30;
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-inner {
            padding: 12px;
        }

        .game-bookmark {
            background: #F8F9FA;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            border-left: 3px solid #A7C7E7;
            margin-bottom: 8px;
        }

        .add-game-row {
            padding: 12px;
            border-top: 1px dashed rgba(167, 199, 231, 0.15);
            display: flex;
            justify-content: center;
        }

        @media (max-width:480px) {
            .dropdown-menu {
                right: 10px;
                left: 10px;
                width: auto;
                max-width: unset;
            }
        }
    </style>
    <style>
        @view-transition {
            navigation: auto;
        }
    </style>
    <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
    <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
    <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
</head>

<body>
    <!-- é ‚éƒ¨è³‡è¨Š Bar -->
    <header class="container-fluid top-info-bar" role="banner">
        <div class="teacher-info">
            <div class="teacher-avatar" onclick="toggleStudentMode()" aria-label="åˆ‡æ›å­¸ç”Ÿæ¨¡å¼" title="é»æ“Šåˆ‡æ›å–®äºº/å°çµ„æ¨¡å¼">
                ğŸ‘©â€ğŸ«
            </div><span class="student-display" id="student-display">ä½ æ­£åœ¨æ•™å°ï¼šå°æ˜</span>
        </div><button class="switch-student-btn" onclick="showSwitchStudentModal()" aria-label="åˆ‡æ›å­¸ç”Ÿ"> åˆ‡æ›å­¸ç”Ÿ
        </button>
        <div class="group-tip" id="group-tip" aria-live="polite">
            ğŸ¤ å°çµ„æ¨¡å¼ï¼šè¨˜å¾—ç•™æ„æ¯ä½å­¸ç”Ÿå˜…é€²åº¦ï¼
        </div>
    </header>
    <div class="container">
        <!-- ä¸»è¦éŠæˆ²å€åŸŸ -->
        <main class="game-section" role="main">
            <div class="game-info-overlay">
                <div class="game-header">
                    <div class="game-cover" id="game-cover" aria-hidden="true">
                        ğŸ
                    </div>
                    <div class="game-details">
                        <h1 class="game-title" id="game-title">Fruit Match</h1>
                        <div class="game-tags" role="list" aria-label="éŠæˆ²æ¨™ç±¤"><span class="tag" role="listitem"
                                id="skill-tag">Vocabulary</span> <span class="tag level" role="listitem"
                                id="level-tag">KS1</span> <span class="tag" role="listitem"
                                id="category-tag">Language</span>
                        </div>
                    </div>
                    <div class="game-controls"><button class="fullscreen-btn" onclick="toggleFullscreen()"
                            aria-label="å…¨è¢å¹•æ¨¡å¼"> <i class="fa-solid fa-expand" aria-hidden="true"></i> </button>

                        <!-- åŠ å…¥æ–°éŠæˆ² -->
                        <section class="dropdown-nav" id="bookmarked-dropdown">
                            <div class="dropdown-toggle" id="bookmarked-toggle" role="button" tabindex="0"
                                aria-expanded="false" aria-controls="bookmarked-content"
                                onclick="toggleDropdown('bookmarked')"
                                onkeydown="if(event.key==='Enter'||event.key===' ') { event.preventDefault(); toggleDropdown('bookmarked'); }">
                                <h2 class="dropdown-title"><i class="fa-solid fa-gamepad" aria-hidden="true" style="margin-right:8px;"></i>åˆ‡æ›éŠæˆ²</h2>
                                <span class="dropdown-icon ms-2" id="bookmarked-icon" aria-hidden="true">â–¼</span>
                            </div>

                            <div class="dropdown-menu" id="bookmarked-content" aria-hidden="true">
                                <div class="dropdown-inner">
                                    <div class="bookmarked-games" role="list">
                                        <article class="game-bookmark" onclick="loadBookmarkedGame('shape-pairs')"
                                            role="listitem" tabindex="0">
                                            <div class="bookmark-title">ğŸ”· Shape Pairs</div>
                                            <div class="bookmark-meta">Geometry â€¢ æ˜¨å¤©ä½¿ç”¨</div>
                                        </article>

                                        <article class="game-bookmark" onclick="loadBookmarkedGame('word-listen')"
                                            role="listitem" tabindex="0">
                                            <div class="bookmark-title">ğŸ‘‚ Word Listen</div>
                                            <div class="bookmark-meta">Listening â€¢ 3å¤©å‰</div>
                                        </article>

                                        <article class="game-bookmark" onclick="loadBookmarkedGame('number-count')"
                                            role="listitem" tabindex="0">
                                            <div class="bookmark-title">ğŸ”¢ Number Count</div>
                                            <div class="bookmark-meta">Math â€¢ 1é€±å‰</div>
                                        </article>
                                    </div>

                                    <div class="add-game-row">
                                        <button class="add-game-btn" onclick="showAddGameModal()" aria-label="åŠ å…¥æ–°éŠæˆ²">â•
                                            åŠ å…¥æ–°éŠæˆ²</button>
                                    </div>
                                </div>
                            </div>
                        </section>
                    </div>
                </div>
            </div>
            <div class="game-container"><iframe class="game-iframe" id="game-iframe" src="games/free/matching.html"
                    title="éŠæˆ²å…§å®¹" aria-label="Fruit Match éŠæˆ²"></iframe>
                <iframe class="game-iframe" id="game-iframe" src="" title="éŠæˆ²å…§å®¹" aria-label="Fruit Match éŠæˆ²"></iframe>
            </div>
    </div>
    </main>
    <nav class="bottom-toolbar" role="navigation" aria-label="ä¸»è¦æ“ä½œ">
        <button class="toolbar-btn btn-complete" aria-label="å®Œæˆæ­¤éŠæˆ²"> âœ… å®ŒæˆéŠæˆ² </button>
        <button class="toolbar-btn btn-end" onclick="endSession()" aria-label="çµæŸèª²å ‚"> â¹ çµæŸèª²å ‚ </button>
        </div>
    </nav>
    </div><!-- Premium å‡ç´šæµ®å‹•å¡ç‰‡ -->
    <div class="premium-float" id="premium-float" onclick="showUpgradeModal()" role="button" tabindex="0"
        aria-label="å‡ç´šè‡³ Premium">
        <div class="premium-title">
            ğŸŒŸ å‡ç´šè‡³ Premium
        </div>
        <div class="premium-desc">
            è§£é– AI æ¨è–¦æ¨¡çµ„èˆ‡å®Œæ•´ç´€éŒ„
        </div>
    </div><!-- åˆ‡æ›å­¸ç”Ÿ Modal -->
    <div id="switchStudentModal" class="modal" role="dialog" aria-labelledby="switch-modal-title" aria-hidden="true">
        <div class="modal-content">
            <header class="modal-header">
                <h3 class="modal-title" id="switch-modal-title">åˆ‡æ›å­¸ç”Ÿ</h3><button class="close"
                    onclick="closeSwitchStudentModal()" aria-label="é—œé–‰">Ã—</button>
            </header>
            <form id="switchStudentForm">
                <div class="form-group"><label for="student-list">é¸æ“‡å­¸ç”Ÿï¼š</label> <select id="student-list">
                        <option value="å°æ˜">å°æ˜</option>
                        <option value="é˜¿èŠ±">é˜¿èŠ±</option>
                        <option value="é˜¿å¼·">é˜¿å¼·</option>
                        <option value="å°ç¾">å°ç¾</option>
                    </select>
                </div>
                <div class="form-group"><label>èª²å ‚æ¨¡å¼ï¼š</label>
                    <div class="radio-group">
                        <div class="radio-option"><input type="radio" id="single-mode" name="mode" value="single"
                                checked> <label for="single-mode">1 å° 1</label>
                        </div>
                        <div class="radio-option"><input type="radio" id="group-mode" name="mode" value="group"> <label
                                for="group-mode">å°çµ„èª²å ‚</label>
                        </div>
                    </div>
                </div>
                <div class="modal-actions"><button type="button" class="btn-modal btn-secondary"
                        onclick="closeSwitchStudentModal()"> å–æ¶ˆ </button> <button type="submit"
                        class="btn-modal btn-primary"> ç¢ºèªåˆ‡æ› </button>
                </div>
            </form>
        </div>
    </div><!-- åŠ å…¥éŠæˆ² Modal -->
    <div id="addGameModal" class="modal" role="dialog" aria-labelledby="add-game-modal-title" aria-hidden="true">
        <div class="modal-content">
            <header class="modal-header">
                <h3 class="modal-title" id="add-game-modal-title">åŠ å…¥æ–°éŠæˆ²</h3><button class="close"
                    onclick="closeAddGameModal()" aria-label="é—œé–‰">Ã—</button>
            </header>
            <form id="addGameForm">
                <div class="form-group"><label>é¸æ“‡ä¾†æºï¼š</label>
                    <div class="radio-group">
                        <div class="radio-option"><input type="radio" id="platform-source" name="source"
                                value="platform" checked onchange="toggleSourceFields()"> <label
                                for="platform-source">å¹³å°éŠæˆ²åº«</label>
                        </div>
                        <div class="radio-option"><input type="radio" id="external-source" name="source"
                                value="external" onchange="toggleSourceFields()"> <label
                                for="external-source">å¤–éƒ¨é€£çµ</label>
                        </div>
                    </div>
                </div>
                <div id="platform-fields">
                    <div class="form-group"><label for="platform-game">é¸æ“‡éŠæˆ²ï¼š</label> <select id="platform-game"
                            onchange="fillPlatformGameInfo()">
                            <option value="">è«‹é¸æ“‡éŠæˆ²...</option>
                            <option value="fruit-match">ğŸ Fruit Match</option>
                            <option value="shape-pairs">ğŸ”· Shape Pairs</option>
                            <option value="word-listen">ğŸ‘‚ Word Listen</option>
                            <option value="number-count">ğŸ”¢ Number Count</option>
                            <option value="color-mix">ğŸ¨ Color Mix</option>
                        </select>
                    </div>
                </div>
                <div id="external-fields" style="display: none;">
                    <div class="form-group"><label for="external-url">éŠæˆ²é€£çµï¼š</label> <input type="url" id="external-url"
                            placeholder="https://example.com/game" required>
                    </div>
                </div>
                <div class="form-group"><label for="game-name">éŠæˆ²åç¨±ï¼š</label> <input type="text" id="game-name"
                        placeholder="è¼¸å…¥éŠæˆ²åç¨±" required>
                </div>
                <div class="form-group"><label for="game-skills">æŠ€èƒ½æ¨™ç±¤ï¼š</label> <input type="text" id="game-skills"
                        placeholder="ä¾‹å¦‚ï¼šVocabulary, Listening">
                </div>
                <div class="modal-actions"><button type="button" class="btn-modal btn-secondary"
                        onclick="closeAddGameModal()"> å–æ¶ˆ </button> <button type="button"
                        class="btn-modal btn-secondary" onclick="saveAsBookmark()"> å„²å­˜æ›¸ç±¤ </button> <button type="submit"
                        class="btn-modal btn-primary"> ç«‹å³å•Ÿå‹• </button>
                </div>
            </form>
        </div>
    </div><!-- Premium å‡ç´š Modal -->
    <div id="upgradeModal" class="modal" role="dialog" aria-labelledby="upgrade-modal-title" aria-hidden="true">
        <div class="modal-content" style="text-align: center;">
            <header class="modal-header">
                <h3 class="modal-title" id="upgrade-modal-title">ğŸŒŸ å‡ç´šè‡³ Premium</h3><button class="close"
                    onclick="closeUpgradeModal()" aria-label="é—œé–‰">Ã—</button>
            </header>
            <div style="margin: 20px 0;">
                <p style="color: #7F8C8D; margin-bottom: 20px;">è§£é–å®Œæ•´æ•™å­¸åŠŸèƒ½ï¼Œæå‡èª²å ‚æ•ˆç‡ï¼</p>
                <div style="text-align: left; margin: 20px 0;">
                    <div style="margin-bottom: 10px;">
                        âœ¨ AI æ™ºèƒ½æ¨è–¦éŠæˆ²
                    </div>
                    <div style="margin-bottom: 10px;">
                        ğŸ“Š å®Œæ•´å­¸ç¿’ç´€éŒ„åˆ†æ
                    </div>
                    <div style="margin-bottom: 10px;">
                        ğŸ”– ç„¡é™éŠæˆ²æ›¸ç±¤
                    </div>
                    <div style="margin-bottom: 10px;">
                        ğŸ¯ å€‹äººåŒ–å­¸ç¿’è·¯å¾‘
                    </div>
                    <div style="margin-bottom: 10px;">
                        ğŸ’¬ å„ªå…ˆå®¢æœæ”¯æ´
                    </div>
                </div>
            </div>
            <div class="modal-actions" style="justify-content: center;"><button class="btn-modal btn-secondary"
                    onclick="closeUpgradeModal()"> ç¨å¾Œå†èªª </button> <button class="btn-modal btn-primary"
                    onclick="upgradeToPremium()"> äº†è§£ Premium åŠŸèƒ½ </button>
            </div>
        </div>
    </div>

    <!-- æ–°å¢ï¼šå®ŒæˆéŠæˆ²å½ˆçª— / ä»¥åŠæŠŠ iframe é¡¯ç¤ºæˆã€Œæœ¬å ‚å·²å®Œæˆã€æª¢è¦– -->
    <div id="completedModal" class="modal" role="dialog" aria-labelledby="completed-modal-title" aria-hidden="true"
        style="display:none;">
        <div class="modal-content">
            <header class="modal-header">
                <h3 class="modal-title" id="completed-modal-title">âœ… æœ¬å ‚å·²å®Œæˆçš„éŠæˆ²</h3>
                <button class="close" onclick="closeCompletedModal()" aria-label="é—œé–‰">Ã—</button>
            </header>
            <div id="completed-list" style="max-height:320px; overflow:auto; margin:8px 0 16px 0; color:#2C3E50;"></div>
            <div class="modal-actions" style="justify-content:space-between;">
                <button class="btn-modal btn-secondary" onclick="closeCompletedModal()"> ç¹¼çºŒèª²å ‚ </button>
                <button class="btn-modal btn-end" onclick="endSession()"> çµæŸèª²å ‚ </button>
            </div>
        </div>
    </div>

    <!-- æ–°å¢ï¼šçµæŸèª²å ‚ç¢ºèª Modalï¼ˆæ”¾åœ¨ completedModal æ—é‚Šï¼‰ -->
    <div id="confirmEndModal" class="modal" role="dialog" aria-labelledby="confirm-end-title" aria-hidden="true" style="display:none;">
        <div class="modal-content">
            <header class="modal-header">
                <h3 class="modal-title" id="confirm-end-title">âš ï¸ ç¢ºèªçµæŸèª²å ‚</h3>
                <button class="close" onclick="closeConfirmEndModal()" aria-label="é—œé–‰">Ã—</button>
            </header>
            <div style="padding:6px 0 0 0; color:#2C3E50;">
                <p>ç¢ºå®šè¦çµæŸæœ¬å ‚èª²ä¸¦å‰å¾€å›é¥‹é é¢å—ï¼Ÿ</p>
            </div>
            <div class="modal-actions" style="justify-content:space-between;margin-top:18px;">
                <button type="button" class="btn-modal btn-secondary" onclick="closeConfirmEndModal()"> å–æ¶ˆ </button>
                <button type="button" class="btn-modal btn-end" onclick="confirmEndSession()"> ç¢ºèªçµæŸä¸¦å‰å¾€å›é¥‹ </button>
            </div>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let currentStudent = 'å°æ˜';
        let isGroupMode = false;
        let sessionStartTime = new Date();
        let currentGame = {
            id: 'fruit-match',
            title: 'Fruit Match',
            skills: 'Vocabulary',
            level: 'KS1',
            category: 'Language',
            cover: 'ğŸ',
            url: 'games/speaking/creative-speaking/MyDreamHouse.html'
        };

        // å¹³å°éŠæˆ²åº«è³‡æ–™
        const platformGames = {
            'fruit-match': {
                title: 'Fruit Match',
                skills: 'Vocabulary',
                level: 'KS1',
                category: 'Language',
                cover: 'ğŸ',
                url: 'games/free/matching.html'
            },
            'shape-pairs': {
                title: 'Shape Pairs',
                skills: 'Geometry',
                level: 'KS1',
                category: 'Math',
                cover: 'ğŸ”·',
                url: 'games/free/SuperheroRescueLetters.html'
            },
            'word-listen': {
                title: 'Word Listen',
                skills: 'Listening',
                level: 'KS2',
                category: 'Language',
                cover: 'ğŸ‘‚',
                url: 'games/grammar/SentenceSurgery.html'
            },
            'number-count': {
                title: 'Number Count',
                skills: 'Counting',
                level: 'KS1',
                category: 'Math',
                cover: 'ğŸ”¢',
                url: 'games/financial-literacy/KidsToyShop.html'
            },
            'color-mix': {
                title: 'Color Mix',
                skills: 'Art, Colors',
                level: 'KS1',
                category: 'Art',
                cover: 'ğŸ¨',
                url: 'games/financial-literacy/MiniBusinessTycoonSuper.html'
            }
        };

        // å­¸ç”Ÿç´€éŒ„
        let studentRecords = [];

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function () {
            updateStudentDisplay();
            // è¨­å®šåˆå§‹éŠæˆ² iframe src
            document.getElementById('game-iframe').src = currentGame.url;
        });

        // åˆ‡æ›å­¸ç”Ÿæ¨¡å¼
        function toggleStudentMode() {
            isGroupMode = !isGroupMode;
            updateStudentDisplay();

            if (isGroupMode) {
                showToast('å·²åˆ‡æ›è‡³å°çµ„æ¨¡å¼');
            } else {
                showToast('å·²åˆ‡æ›è‡³å–®äººæ¨¡å¼');
            }
        }

        // æ›´æ–°å­¸ç”Ÿé¡¯ç¤º
        function updateStudentDisplay() {
            const studentDisplay = document.getElementById('student-display');
            const groupTip = document.getElementById('group-tip');

            if (isGroupMode) {
                studentDisplay.textContent = 'ä½ è€Œå®¶æ•™ç·Šï¼šå°æ˜ã€é˜¿èŠ±ã€é˜¿å¼·';
                groupTip.classList.add('show');
            } else {
                studentDisplay.textContent = `ä½ æ­£åœ¨æ•™å°ï¼š${currentStudent}`;
                groupTip.classList.remove('show');
            }
        }

        // é¡¯ç¤ºåˆ‡æ›å­¸ç”Ÿ Modal
        function showSwitchStudentModal() {
            document.getElementById('switchStudentModal').style.display = 'block';
            document.getElementById('switchStudentModal').setAttribute('aria-hidden', 'false');
        }

        // é—œé–‰åˆ‡æ›å­¸ç”Ÿ Modal
        function closeSwitchStudentModal() {
            document.getElementById('switchStudentModal').style.display = 'none';
            document.getElementById('switchStudentModal').setAttribute('aria-hidden', 'true');
        }

        // è™•ç†åˆ‡æ›å­¸ç”Ÿè¡¨å–®
        document.getElementById('switchStudentForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const selectedStudent = document.getElementById('student-list').value;
            const selectedMode = document.querySelector('input[name="mode"]:checked').value;

            currentStudent = selectedStudent;
            isGroupMode = (selectedMode === 'group');

            updateStudentDisplay();
            closeSwitchStudentModal();

            showToast(`å·²åˆ‡æ›è‡³ ${selectedStudent}${isGroupMode ? ' (å°çµ„æ¨¡å¼)' : ''}`);
        });

        // åˆ‡æ›éŠæˆ²
        function switchGame() {
            const select = document.getElementById('game-select');
            const gameId = select.value;

            if (gameId && platformGames[gameId]) {
                loadGame(gameId);
                select.value = '';
            }
        }

        // è¼‰å…¥éŠæˆ²
        function loadGame(gameId) {
            if (platformGames[gameId]) {
                currentGame = {
                    id: gameId,
                    ...platformGames[gameId]
                };
                updateGameDisplay();
                showToast(`å·²åˆ‡æ›è‡³ ${currentGame.title}`);
            }
        }

        // æ›´æ–°éŠæˆ²é¡¯ç¤º
        function updateGameDisplay() {
            document.getElementById('game-title').textContent = currentGame.title;
            document.getElementById('skill-tag').textContent = currentGame.skills;
            document.getElementById('level-tag').textContent = currentGame.level;
            document.getElementById('category-tag').textContent = currentGame.category;
            document.getElementById('game-cover').textContent = currentGame.cover;
            document.getElementById('game-iframe').src = currentGame.url;
        }

        // å®ŒæˆéŠæˆ²
        // Replace/augment completeGame() to show completed view in iframe and open modal
        function completeGame() {
            console.log('completeGame() called');
            const record = {
                student: isGroupMode ? 'å°æ˜ã€é˜¿èŠ±ã€é˜¿å¼·' : currentStudent,
                gameId: currentGame.id,
                gameTitle: currentGame.title,
                startedAt: new Date(),
                finishedAt: new Date(),
                duration: Math.floor(Math.random() * 300) + 60
            };

            studentRecords.push(record);
            showToast(`âœ… ${currentGame.title} å·²å®Œæˆï¼`);

            // é¡¯ç¤ºå®Œæˆå½ˆçª—ï¼ˆè©¢å•æ˜¯å¦ç©ä¸‹ä¸€å€‹æˆ–çµæŸï¼‰
            showCompletedModal();
        }

        // å½ˆçª—æ§åˆ¶ï¼ˆæ›´æ–°ï¼šåŒæ™‚å¡«å……å·²å®ŒæˆéŠæˆ²æ¸…å–®ï¼‰
        function showCompletedModal() {
            console.log('showCompletedModal() called');
            const modal = document.getElementById('completedModal');
            const list = document.getElementById('completed-list');
            if (!modal) {
                console.error('completedModal element missing');
                return;
            }
            if (!list) {
                console.error('completed-list element missing');
                return;
            }

            // å¡«å……æ¸…å–®å…§å®¹
            if (!Array.isArray(studentRecords) || studentRecords.length === 0) {
                list.innerHTML = '<div style="color:#7F8C8D;padding:8px 0;">å°šæœªå®Œæˆä»»ä½•éŠæˆ²</div>';
            } else {
                list.innerHTML = studentRecords.map(r => {
                    const time = new Date(r.finishedAt).toLocaleString();
                    const student = r.student ? escapeHtml(r.student) : 'â€”';
                    const title = r.gameTitle ? escapeHtml(r.gameTitle) : 'æœªçŸ¥éŠæˆ²';
                    const duration = r.duration ? `${r.duration}s` : 'â€”';
                    return `<div style="padding:10px 0;border-bottom:1px solid #eee;">
                <div style="font-weight:600;color:#2C3E50">${title}</div>
                <div style="font-size:0.85rem;color:#7F8C8D">ç©å®¶ï¼š${student} â€¢ ${time} â€¢ ${duration}</div>
              </div>`;
                }).join('');
            }

            // ç¢ºä¿ modal åœ¨ body æœ€å¾Œé¢ã€z-index è¶³å¤ é«˜
            if (modal.parentNode !== document.body) {
                document.body.appendChild(modal);
            }
            modal.style.zIndex = 99999;
            modal.style.display = 'block';
            modal.setAttribute('aria-hidden', 'false');
        }

        // å°å·¥å…·ï¼šç°¡å–® escape HTMLï¼ˆè‹¥å°šæœªå®šç¾©ï¼‰
        function escapeHtml(str) {
            if (!str) return '';
            return String(str).replace(/[&<>"']/g, function (m) {
                return ({
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                } [m]);
            });
        }

        function closeCompletedModal() {
            const modal = document.getElementById('completedModal');
            if (!modal) return;
            modal.style.display = 'none';
            modal.setAttribute('aria-hidden', 'true');

            // è‹¥è¦å›åˆ°å‰›å‰›çš„éŠæˆ²è¦–åœ–ï¼Œé‡æ–°è¼‰å…¥ currentGame.url
            const iframe = document.getElementById('game-iframe');
            if (iframe && currentGame && currentGame.url) {
                iframe.src = currentGame.url;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const completeBtn = document.querySelector('.btn-complete');
            if (completeBtn) {
                completeBtn.addEventListener('click', () => {
                    console.log('completeBtn clicked');
                    if (typeof completeGame === 'function') {
                        try {
                            completeGame();
                        } catch (err) {
                            console.error('completeGame threw', err);
                        }
                    } else {
                        console.error('completeGame is not a function');
                    }
                });
            } else {
                console.warn('.btn-complete not found');
            }
        });

        // çµæŸèª²å ‚
        function endSession() {
  // open confirmation modal instead of immediately ending
  const modal = document.getElementById('confirmEndModal');
  if (modal) {
    modal.style.display = 'block';
    modal.setAttribute('aria-hidden', 'false');
    modal.style.zIndex = 100000;
    return;
  }
  // fallback: if modal missing, still end
  doEndSession();
}

function closeConfirmEndModal() {
  const modal = document.getElementById('confirmEndModal');
  if (!modal) return;
  modal.style.display = 'none';
  modal.setAttribute('aria-hidden', 'true');
}

// actual end logic (separated so it can be reused)
function doEndSession() {
  // close other UI that should be closed
  if (typeof closeCompletedModal === 'function') closeCompletedModal();
  // show a toast then redirect
  showToast('èª²å ‚å·²çµæŸï¼Œå‰å¾€å›é¥‹é é¢...');
  // small delay so toast is visible
  setTimeout(() => {
    window.location.href = 'lessonFeedback.html';
  }, 400);
}

// called when teacher confirms
function confirmEndSession() {
  // ensure modal closes
  closeConfirmEndModal();
  // perform end behavior
  doEndSession();
}

// ensure clicking outside the confirm modal closes it (add to existing background click handler)
window.addEventListener('click', function (e) {
  const confirmModal = document.getElementById('confirmEndModal');
  if (confirmModal && e.target === confirmModal) {
    closeConfirmEndModal();
  }
});

        // å…¨è¢å¹•åŠŸèƒ½
        function toggleFullscreen() {
            const iframe = document.getElementById('game-iframe');

            if (!document.fullscreenElement) {
                iframe.requestFullscreen().then(() => {
                    showToast('å·²é€²å…¥å…¨è¢å¹•æ¨¡å¼');
                }).catch(() => {
                    showToast('ç„¡æ³•é€²å…¥å…¨è¢å¹•æ¨¡å¼');
                });
            } else {
                document.exitFullscreen().then(() => {
                    showToast('å·²é€€å‡ºå…¨è¢å¹•æ¨¡å¼');
                });
            }
        }

        // åˆ‡æ›å¡ç‰‡å±•é–‹/æ”¶èµ·
        function toggleCard(cardId) {
            const content = document.getElementById(`${cardId}-content`);
            const icon = document.getElementById(`${cardId}-icon`);
            const header = document.querySelector(`[aria-controls="${cardId}-content"]`);

            const isExpanded = content.classList.contains('expanded');

            if (isExpanded) {
                content.classList.remove('expanded');
                icon.classList.remove('rotated');
                content.setAttribute('aria-hidden', 'true');
                header.setAttribute('aria-expanded', 'false');
            } else {
                content.classList.add('expanded');
                icon.classList.add('rotated');
                content.setAttribute('aria-hidden', 'false');
                header.setAttribute('aria-expanded', 'true');
            }
        }

        // è¼‰å…¥æ›¸ç±¤éŠæˆ²
        function loadBookmarkedGame(gameId) {
            loadGame(gameId);
        }

        // é¡¯ç¤ºåŠ å…¥éŠæˆ² Modal
        function showAddGameModal() {
            document.getElementById('addGameModal').style.display = 'block';
            document.getElementById('addGameModal').setAttribute('aria-hidden', 'false');
            toggleSourceFields();
        }

        // é—œé–‰åŠ å…¥éŠæˆ² Modal
        function closeAddGameModal() {
            document.getElementById('addGameModal').style.display = 'none';
            document.getElementById('addGameModal').setAttribute('aria-hidden', 'true');
            document.getElementById('addGameForm').reset();
        }

        // é¡¯ç¤ºå‡ç´š Modal
        function showUpgradeModal() {
            document.getElementById('upgradeModal').style.display = 'block';
            document.getElementById('upgradeModal').setAttribute('aria-hidden', 'false');
        }

        // é—œé–‰å‡ç´š Modal
        function closeUpgradeModal() {
            document.getElementById('upgradeModal').style.display = 'none';
            document.getElementById('upgradeModal').setAttribute('aria-hidden', 'true');
        }

        // é¡¯ç¤º Premium æµ®å‹•å¡ç‰‡
        function showPremiumFloat() {
            const premiumFloat = document.getElementById('premium-float');
            premiumFloat.classList.add('show');

            setTimeout(() => {
                premiumFloat.classList.remove('show');
            }, 5000);
        }

        // å‡ç´šè‡³ Premium
        function upgradeToPremium() {
            showToast('è·³è½‰è‡³ Premium åŠŸèƒ½ä»‹ç´¹é é¢...');
            closeUpgradeModal();
        }

        // åˆ‡æ›ä¾†æºæ¬„ä½
        function toggleSourceFields() {
            const platformFields = document.getElementById('platform-fields');
            const externalFields = document.getElementById('external-fields');
            const isPlatform = document.getElementById('platform-source').checked;

            if (isPlatform) {
                platformFields.style.display = 'block';
                externalFields.style.display = 'none';
                document.getElementById('external-url').removeAttribute('required');
            } else {
                platformFields.style.display = 'none';
                externalFields.style.display = 'block';
                document.getElementById('external-url').setAttribute('required', '');
            }
        }

        // å¡«å…¥å¹³å°éŠæˆ²è³‡è¨Š
        function fillPlatformGameInfo() {
            const gameId = document.getElementById('platform-game').value;

            if (gameId && platformGames[gameId]) {
                const game = platformGames[gameId];
                document.getElementById('game-name').value = game.title;
                document.getElementById('game-skills').value = game.skills;
            }
        }

        // å„²å­˜ç‚ºæ›¸ç±¤
        function saveAsBookmark() {
            const formData = getFormData();
            if (validateForm(formData)) {
                addToBookmarks(formData);
                showToast('éŠæˆ²å·²åŠ å…¥æ›¸ç±¤ï¼');
                closeAddGameModal();
            }
        }

        // è™•ç†è¡¨å–®æäº¤
        document.getElementById('addGameForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const formData = getFormData();
            if (validateForm(formData)) {
                const gameId = `custom-${Date.now()}`;
                const newGame = {
                    id: gameId,
                    title: formData.name,
                    skills: formData.skills,
                    level: 'Custom',
                    category: 'Custom',
                    cover: 'ğŸ®',
                    url: formData.url || createCustomGameUrl(formData.name)
                };

                platformGames[gameId] = newGame;
                currentGame = newGame;
                updateGameDisplay();

                showToast(`å·²å•Ÿå‹• ${formData.name}ï¼`);
                closeAddGameModal();
            }
        });

        // ç²å–è¡¨å–®è³‡æ–™
        function getFormData() {
            const isPlatform = document.getElementById('platform-source').checked;

            return {
                source: isPlatform ? 'platform' : 'external',
                platformGame: document.getElementById('platform-game').value,
                url: document.getElementById('external-url').value,
                name: document.getElementById('game-name').value,
                skills: document.getElementById('game-skills').value
            };
        }

        // é©—è­‰è¡¨å–®
        function validateForm(data) {
            if (!data.name.trim()) {
                showToast('è«‹è¼¸å…¥éŠæˆ²åç¨±');
                return false;
            }

            if (data.source === 'external' && !data.url.trim()) {
                showToast('è«‹è¼¸å…¥éŠæˆ²é€£çµ');
                return false;
            }

            if (data.source === 'platform' && !data.platformGame) {
                showToast('è«‹é¸æ“‡å¹³å°éŠæˆ²');
                return false;
            }

            return true;
        }

        // åŠ å…¥åˆ°æ›¸ç±¤
        function addToBookmarks(data) {
            const bookmarksContainer = document.querySelector('.bookmarked-games');
            const bookmark = document.createElement('article');
            bookmark.className = 'game-bookmark';
            bookmark.setAttribute('role', 'listitem');
            bookmark.setAttribute('tabindex', '0');
            bookmark.onclick = () => loadCustomGame(data);

            bookmark.innerHTML = `
                <div class="bookmark-title">ğŸ® ${data.name}</div>
                <div class="bookmark-meta">${data.skills} â€¢ å‰›å‰›åŠ å…¥</div>
            `;

            bookmarksContainer.appendChild(bookmark);
        }

        // è¼‰å…¥è‡ªè¨‚éŠæˆ²
        function loadCustomGame(data) {
            const gameId = `custom-${Date.now()}`;
            const newGame = {
                id: gameId,
                title: data.name,
                skills: data.skills,
                level: 'Custom',
                category: 'Custom',
                cover: 'ğŸ®',
                url: data.url || createCustomGameUrl(data.name)
            };

            currentGame = newGame;
            updateGameDisplay();
            showToast(`å·²è¼‰å…¥ ${data.name}`);
        }

        // å‰µå»ºè‡ªè¨‚éŠæˆ² URL
        function createCustomGameUrl(gameName) {
            return `data:text/html,<html><body style='margin:0;padding:40px;background:linear-gradient(135deg,%23A7C7E7,%23FFF5B2);font-family:Arial;text-align:center;'><h2 style='color:%232C3E50;margin-top:80px;'>ğŸ® ${encodeURIComponent(gameName)}</h2><p style='color:%237F8C8D;'>è‡ªè¨‚éŠæˆ²è¼‰å…¥ä¸­...</p><div style='margin-top:40px;font-size:48px;'>ğŸš€</div></body></html>`;
        }

        // é¡¯ç¤ºæç¤ºè¨Šæ¯
        function showToast(message) {
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }

            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');

            document.body.appendChild(toast);

            setTimeout(() => {
                if (toast.parentNode) {
                    toast.style.animation = 'slideInRight 0.3s ease reverse';
                    setTimeout(() => toast.remove(), 300);
                }
            }, 3000);
        }

        // éµç›¤å°èˆªæ”¯æ´
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                // é—œé–‰æ‰€æœ‰ Modal
                closeSwitchStudentModal();
                closeAddGameModal();
                closeUpgradeModal();
            }
        });

        // é»æ“Š Modal èƒŒæ™¯é—œé–‰
        window.addEventListener('click', function (e) {
            const switchModal = document.getElementById('switchStudentModal');
            const addModal = document.getElementById('addGameModal');
            const upgradeModal = document.getElementById('upgradeModal');

            if (e.target === switchModal) {
                closeSwitchStudentModal();
            }
            if (e.target === addModal) {
                closeAddGameModal();
            }
            if (e.target === upgradeModal) {
                closeUpgradeModal();
            }
        });

        // ç‚ºæ›¸ç±¤é …ç›®æ·»åŠ éµç›¤æ”¯æ´
        document.addEventListener('keydown', function (e) {
            if (e.target.classList.contains('game-bookmark') && (e.key === 'Enter' || e.key === ' ')) {
                e.preventDefault();
                e.target.click();
            }
        });

        // Premium æµ®å‹•å¡ç‰‡éµç›¤æ”¯æ´
        document.getElementById('premium-float').addEventListener('keydown', function (e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                showUpgradeModal();
            }
        });

        function toggleDropdown(id) {
            const menu = document.getElementById(`${id}-content`);
            const icon = document.getElementById(`${id}-icon`);
            const toggle = document.getElementById(`${id}-toggle`);
            if (!menu || !toggle) return;
            const isOpen = menu.classList.toggle('show');
            menu.setAttribute('aria-hidden', (!isOpen).toString());
            toggle.setAttribute('aria-expanded', isOpen.toString());
            if (icon) icon.style.transform = isOpen ? 'rotate(180deg)' : '';
        }

        // close dropdown when clicking outside
        document.addEventListener('click', function (e) {
            const dropdown = document.getElementById('bookmarked-dropdown');
            if (!dropdown) return;
            if (!dropdown.contains(e.target)) {
                const menu = document.getElementById('bookmarked-content');
                const toggle = document.getElementById('bookmarked-toggle');
                const icon = document.getElementById('bookmarked-icon');
                if (menu && menu.classList.contains('show')) {
                    menu.classList.remove('show');
                    menu.setAttribute('aria-hidden', 'true');
                    if (toggle) toggle.setAttribute('aria-expanded', 'false');
                    if (icon) icon.style.transform = '';
                }
            }
        });

        // close with Escape
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                const menu = document.getElementById('bookmarked-content');
                const toggle = document.getElementById('bookmarked-toggle');
                const icon = document.getElementById('bookmarked-icon');
                if (menu && menu.classList.contains('show')) {
                    menu.classList.remove('show');
                    menu.setAttribute('aria-hidden', 'true');
                    if (toggle) toggle.setAttribute('aria-expanded', 'false');
                    if (icon) icon.style.transform = '';
                }
            }
        });
    </script>
    <script>
        (function () {
            function c() {
                var b = a.contentDocument || a.contentWindow.document;
                if (b) {
                    var d = b.createElement('script');
                    d.innerHTML =
                        "window.__CF$cv$params={r:'990accd592777695',t:'MTc2MDgxOTQ5NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";
                    b.getElementsByTagName('head')[0].appendChild(d)
                }
            }
            if (document.body) {
                var a = document.createElement('iframe');
                a.height = 1;
                a.width = 1;
                a.style.position = 'absolute';
                a.style.top = 0;
                a.style.left = 0;
                a.style.border = 'none';
                a.style.visibility = 'hidden';
                document.body.appendChild(a);
                if ('loading' !== document.readyState) c();
                else if (window.addEventListener) document.addEventListener('DOMContentLoaded', c);
                else {
                    var e = document.onreadystatechange || function () {};
                    document.onreadystatechange = function (b) {
                        e(b);
                        'loading' !== document.readyState && (document.onreadystatechange = e, c())
                    }
                }
            }
        })();
    </script>
</body>

</html>