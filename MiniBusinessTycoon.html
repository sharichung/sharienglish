<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mini Business Tycoon - English Learning Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background: linear-gradient(135deg, #87CEEB 0%, #98FB98 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .game-container {
            width: 95%;
            max-width: 1200px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .screen {
            display: none;
            padding: 20px;
            text-align: center;
        }

        .screen.active {
            display: block;
        }

        .title {
            font-size: 3em;
            color: #FF6B6B;
            text-shadow: 3px 3px 0px #FFE66D;
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {

            0%,
            20%,
            50%,
            80%,
            100% {
                transform: translateY(0);
            }

            40% {
                transform: translateY(-10px);
            }

            60% {
                transform: translateY(-5px);
            }
        }

        .shop-visual {
            width: 300px;
            height: 200px;
            background: linear-gradient(45deg, #FF9A9E 0%, #FECFEF 50%, #FECFEF 100%);
            border: 5px solid #FF6B6B;
            border-radius: 20px;
            margin: 20px auto;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .shop-visual::before {
            content: "üè™";
            font-size: 4em;
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
        }

        .money-display {
            font-size: 2em;
            color: #4ECDC4;
            font-weight: bold;
            margin: 20px 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .btn {
            background: linear-gradient(45deg, #FF6B6B, #FF8E8E);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2em;
            font-weight: bold;
            border-radius: 25px;
            cursor: pointer;
            margin: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-green {
            background: linear-gradient(45deg, #4ECDC4, #44A08D);
        }

        .btn-blue {
            background: linear-gradient(45deg, #667eea, #764ba2);
        }

        .btn-yellow {
            background: linear-gradient(45deg, #FFE66D, #FF6B6B);
        }

        .btn-purple {
            background: linear-gradient(45deg, #A8EDEA, #FED6E3);
            color: #333;
        }

        .game-header {
            display: flex;
            justify-content: space-around;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            margin: -20px -20px 20px -20px;
        }

        .stat-box {
            text-align: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            min-width: 120px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            margin-top: 5px;
        }

        .game-visual {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 250px;
            border-radius: 15px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .shop-scene {
            font-size: 6em;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .customers {
            position: absolute;
            bottom: 20px;
            left: 20px;
            font-size: 2em;
            animation: walk 4s linear infinite;
        }

        @keyframes walk {
            0% {
                left: -50px;
            }

            100% {
                left: calc(100% + 50px);
            }
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 80%;
            max-width: 600px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .modal h2 {
            color: #FF6B6B;
            margin-bottom: 20px;
            font-size: 2em;
        }

        .option-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .option-btn {
            background: linear-gradient(45deg, #4ECDC4, #44A08D);
            color: white;
            border: none;
            padding: 20px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .option-btn:hover {
            transform: scale(1.05);
        }

        .event-card {
            background: linear-gradient(45deg, #FFE66D, #FF6B6B);
            padding: 30px;
            border-radius: 20px;
            margin: 20px 0;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .event-card h3 {
            font-size: 2em;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            margin-bottom: 15px;
        }

        .event-card p {
            font-size: 1.3em;
            color: #333;
            background: rgba(255, 255, 255, 0.8);
            padding: 15px;
            border-radius: 10px;
        }

        .vocabulary-box {
            background: linear-gradient(45deg, #A8EDEA, #FED6E3);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .vocabulary-box h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .market-news {
            background: linear-gradient(45deg, #FFE66D, #FF9A9E);
            padding: 15px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
        }

        .market-news h4 {
            color: #333;
            margin-bottom: 8px;
            font-size: 1.2em;
        }

        .market-news p {
            color: #333;
            font-weight: bold;
            font-size: 1.1em;
        }

        .vocab-words {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .vocab-word {
            background: white;
            padding: 8px 15px;
            border-radius: 20px;
            color: #333;
            font-weight: bold;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .instructions {
            text-align: left;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .instructions h3 {
            color: #FF6B6B;
            margin-bottom: 15px;
        }

        .instructions ul {
            margin-left: 20px;
        }

        .instructions li {
            margin: 10px 0;
            font-size: 1.1em;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .summary-card {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .summary-card h4 {
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .summary-card .value {
            font-size: 2em;
            font-weight: bold;
        }

        .achievements-section {
            margin: 30px 0;
        }

        .achievements-section h3 {
            color: #FF6B6B;
            font-size: 1.8em;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .achievement-badge {
            background: linear-gradient(45deg, #FFE66D, #FF6B6B);
            padding: 15px;
            border-radius: 15px;
            text-align: center;
            color: white;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .achievement-badge .badge-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .achievement-badge .badge-title {
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .achievement-badge .badge-desc {
            font-size: 0.9em;
            opacity: 0.9;
        }

        @media (max-width: 768px) {
            .title {
                font-size: 2em;
            }

            .game-header {
                flex-direction: column;
                gap: 10px;
            }

            .action-buttons {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
                margin: 10% auto;
            }
        }
    </style>
</head>

<body data-new-gr-c-s-check-loaded="14.1248.0" data-gr-ext-installed="">
    <div class="game-container">
        <!-- Start Screen -->
        <div id="startScreen" class="screen active">
            <h1 class="title">üè™ Mini Business Tycoon üè™</h1>
            <div class="shop-visual">
            </div>
            <div class="money-display">üí∞ Starting Money: $50 üí∞</div>
            <button class="btn btn-green" onclick="showInstructions()">üìñ Instructions</button>
            <button class="btn btn-blue" onclick="startGame()">üöÄ Start Game</button>
            <button class="btn btn-yellow" onclick="resetGame()">üîÑ Reset Game</button>
        </div>

        <!-- Instructions Screen -->
        <div id="instructionsScreen" class="screen">
            <h2 class="title">How to Play</h2>
            <div class="instructions">
                <h3>üéØ Game Rules:</h3>
                <ul>
                    <li><strong>Student speaks in English</strong> - Tell the teacher what you want to do!</li>
                    <li><strong>Teacher clicks buttons</strong> - The teacher will click based on your commands</li>
                    <li><strong>Learn business words</strong> - New vocabulary appears each day</li>
                    <li><strong>Make money</strong> - Buy supplies, sell products, and grow your business!</li>
                    <li><strong>Watch for events</strong> - Special cards can help or challenge you</li>
                </ul>

                <h3>üí¨ Example Commands:</h3>
                <ul>
                    <li>"I want to buy supplies"</li>
                    <li>"Let's advertise our shop"</li>
                    <li>"I think we should upgrade"</li>
                    <li>"Can we sell our products now?"</li>
                </ul>

                <h3>üéØ Goal:</h3>
                <ul>
                    <li>Survive 10 days and become a Business Tycoon!</li>
                    <li>Learn new English words about business and money</li>
                    <li>Have fun making decisions together!</li>
                </ul>
            </div>
            <button class="btn btn-blue" onclick="showStartScreen()">‚¨ÖÔ∏è Back to Start</button>
            <button class="btn btn-green" onclick="startGame()">üöÄ Start Game</button>
        </div>

        <!-- Main Game Screen -->
        <div id="gameScreen" class="screen">
            <div class="game-header">
                <div class="stat-box">
                    <div class="stat-label">üí∞ Money</div>
                    <div class="stat-value" id="moneyDisplay">$50.00</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">üì¶ Inventory</div>
                    <div class="stat-value" id="inventoryDisplay">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">‚ö° Actions Left</div>
                    <div class="stat-value" id="actionsDisplay">4</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">üìÖ Day</div>
                    <div class="stat-value" id="dayDisplay">1</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">‚≠ê Level</div>
                    <div class="stat-value" id="levelDisplay">Beginner</div>
                </div>
            </div>

            <div class="game-visual">
                <div class="shop-scene">üè™</div>
                <div class="customers">üö∂üèª‚Äç‚û°Ô∏èüö∂üèª‚Äç‚ôÄÔ∏è‚Äç‚û°Ô∏è</div>
            </div>

            <div class="vocabulary-box">
                <h4>üìö Today's Business Words:</h4>
                <div class="vocab-words" id="todayVocab"></div>
            </div>

            <div class="market-news" id="marketNews">
                <h4>üì∞ Market News:</h4>
                <p id="marketNewsText">üìà Market is challenging for buyers today</p>
            </div>

            <div class="action-buttons">
                <button class="btn btn-green" onclick="showBuyModal()">üõí Buy Supplies</button>
                <button class="btn btn-blue" onclick="showSellModal()">üí∞ Sell Products</button>
                <button class="btn btn-yellow" onclick="showAdvertiseModal()">üì¢ Advertise</button>
                <button class="btn btn-purple" onclick="showUpgradeModal()">‚¨ÜÔ∏è Upgrade Shop</button>
                <button class="btn" onclick="endDay()">üåô End Day</button>
            </div>
        </div>

        <!-- End of Day Screen -->
        <div id="dayEndScreen" class="screen">
            <h2 class="title">üìä Day Summary</h2>
            <div class="summary-grid">
                <div class="summary-card">
                    <h4>üíµ Revenue</h4>
                    <div class="value" id="revenueDisplay">$0</div>
                </div>
                <div class="summary-card">
                    <h4>üí∏ Costs</h4>
                    <div class="value" id="costsDisplay">$0</div>
                </div>
                <div class="summary-card">
                    <h4>üìà Profit</h4>
                    <div class="value" id="profitDisplay">$0</div>
                </div>
                <div class="summary-card">
                    <h4>üë• Customers</h4>
                    <div class="value" id="customersDisplay">0</div>
                </div>
            </div>
            <div id="spoilageAlert" class="event-card"
                style="display: none; background: linear-gradient(45deg, #FF6B6B, #FF8E8E);">
                <h3>üçãüíî Spoilage Alert!</h3>
                <p id="spoilageText"></p>
            </div>
            <div class="vocabulary-box">
                <h4>üéì Words You Learned Today:</h4>
                <div class="vocab-words" id="learnedVocab"></div>
            </div>
            <button class="btn btn-green" onclick="nextDay()">‚û°Ô∏è Continue to Next Day</button>
        </div>

        <!-- Final Results Screen -->
        <div id="resultsScreen" class="screen">
            <h2 class="title">üéâ Final Results!</h2>
            <div class="shop-visual">
                <div id="finalShopLevel">üè™</div>
            </div>
            <div class="summary-grid">
                <div class="summary-card">
                    <h4>üí∞ Final Money</h4>
                    <div class="value" id="finalMoney">$0</div>
                </div>
                <div class="summary-card">
                    <h4>üèÜ Business Level</h4>
                    <div class="value" id="businessLevel">Beginner</div>
                </div>
                <div class="summary-card">
                    <h4>üìö Words Learned</h4>
                    <div class="value" id="totalWords">0</div>
                </div>
                <div class="summary-card">
                    <h4>üë• Total Customers</h4>
                    <div class="value" id="totalCustomers">0</div>
                </div>
            </div>

            <div class="achievements-section">
                <h3>üèÖ Achievements Unlocked!</h3>
                <div class="achievements-grid" id="achievementsGrid">
                    <!-- Achievements will be populated by JavaScript -->
                </div>
            </div>

            <button class="btn btn-green" onclick="showStartScreen()">üîÑ Play Again</button>
        </div>
    </div>

    <!-- Modals -->
    <div id="buyModal" class="modal">
        <div class="modal-content">
            <h2>üõí Buy Supplies</h2>
            <p>What would you like to buy for your shop?</p>
            <div class="option-grid" id="buyOptions">
                <!-- Options will be populated by JavaScript -->
            </div>
            <button class="btn" onclick="closeModal('buyModal')">‚ùå Cancel</button>
        </div>
    </div>

    <div id="sellModal" class="modal">
        <div class="modal-content">
            <h2>üí∞ Sell Products</h2>
            <p>How much do you want to charge per lemonade?</p>
            <div class="option-grid">
                <button class="option-btn" onclick="sellProducts(1)">üíµ $1 each<br>(Cheap Price)</button>
                <button class="option-btn" onclick="sellProducts(2)">üíµ $2 each<br>(Normal Price)</button>
                <button class="option-btn" onclick="sellProducts(3)">üíµ $3 each<br>(High Price)</button>
            </div>
            <button class="btn" onclick="closeModal('sellModal')">‚ùå Cancel</button>
        </div>
    </div>

    <div id="advertiseModal" class="modal">
        <div class="modal-content">
            <h2>üì¢ Advertise Your Shop</h2>
            <p>How do you want to advertise?</p>
            <div class="option-grid">
                <button class="option-btn" onclick="advertise('flyers', 5)">üìÑ Make Flyers<br>$5</button>
                <button class="option-btn" onclick="advertise('signs', 10)">ü™ß Put Up Signs<br>$10</button>
                <button class="option-btn" onclick="advertise('social', 15)">üì± Social Media<br>$15</button>
            </div>
            <button class="btn" onclick="closeModal('advertiseModal')">‚ùå Cancel</button>
        </div>
    </div>

    <div id="upgradeModal" class="modal">
        <div class="modal-content">
            <h2>‚¨ÜÔ∏è Upgrade Your Shop</h2>
            <p>What upgrade would you like?</p>
            <div class="option-grid">
                <button class="option-btn" onclick="upgrade('table', 20)">ü™ë Better Table<br>$20</button>
                <button class="option-btn" onclick="upgrade('sign', 30)">ü™ß Fancy Sign<br>$30</button>
                <button class="option-btn" onclick="upgrade('location', 50)">üè™ Better Location<br>$50</button>
            </div>
            <button class="btn" onclick="closeModal('upgradeModal')">‚ùå Cancel</button>
        </div>
    </div>

    <div id="eventModal" class="modal">
        <div class="modal-content">
            <div class="event-card">
                <h3>üé≤ Random Event!</h3>
                <p id="eventText"></p>
            </div>
            <button class="btn btn-green" onclick="closeModal('eventModal')">‚úÖ OK</button>
        </div>
    </div>

    <div id="bankruptcyModal" class="modal">
        <div class="modal-content">
            <div class="event-card" style="background: linear-gradient(45deg, #FF6B6B, #FF8E8E);">
                <h3>üí∏ Financial Crisis!</h3>
                <p>You have no money left! Choose what to do:</p>
            </div>
            <div class="option-grid">
                <button class="option-btn" onclick="takeLoan()">üè¶ Take a Loan<br>($30 + $5 daily interest)</button>
                <button class="option-btn" onclick="declareBankruptcy()">üíî Declare Bankruptcy<br>(Game Over)</button>
            </div>
        </div>
    </div>

    <script>
        // Game State
        let gameState = {
            money: 50,
            inventory: 0,
            day: 1,
            revenue: 0,
            costs: 0,
            advertising: 0,
            upgrades: [],
            learnedWords: new Set(),
            actionsLeft: 4,
            lemonBatches: [], // Track lemons with purchase dates
            totalCustomersServed: 0,
            bestProfitDay: 0,
            dailyProfits: [],
            lemonBuyPrice: 2,
            lemonSellPrice: 3,
            spoiledLemons: 0,
            hasLoan: false,
            loanAmount: 0,
            // TRANSACTION TRACKING - Single source of truth for day summary calculations
            dailyTransactions: {
                sales: [], // {quantity: number, price: number, revenue: number}
                purchases: [], // {quantity: number, cost: number}
                expenses: [], // {type: string, amount: number}
                spoilage: 0 // number of lemons spoiled
            }
        };

        // Business Vocabulary
        const businessVocabulary = [
            'profit', 'revenue', 'customer', 'inventory', 'supplies', 'advertise',
            'upgrade', 'investment', 'budget', 'expenses', 'income', 'sales',
            'marketing', 'business', 'entrepreneur', 'competition', 'demand',
            'quality', 'service', 'location', 'price', 'discount', 'promotion'
        ];

        // Random Events
        const randomEvents = [{
                text: "‚òÄÔ∏è Beautiful sunny day! More customers come to your shop.",
                effect: {
                    customers: 1.5
                }
            },
            {
                text: "üåßÔ∏è Rainy weather keeps customers away.",
                effect: {
                    customers: 0.5
                }
            },
            {
                text: "üéâ Local festival brings lots of people!",
                effect: {
                    customers: 2.0
                }
            },
            {
                text: "üèÜ You win a small business award! Get $20 bonus.",
                effect: {
                    money: 20
                }
            },
            {
                text: "üöö Supply truck is late. Inventory costs more today.",
                effect: {
                    supplyCost: 1.5
                }
            },
            {
                text: "üë• A competitor opens nearby. Fewer customers today.",
                effect: {
                    customers: 0.7
                }
            },
            {
                text: "üì∫ You're featured on local news! More customers!",
                effect: {
                    customers: 1.8
                }
            },
            {
                text: "üí° You have a great idea! No cost for advertising today.",
                effect: {
                    freeAd: true
                }
            },
            {
                text: "‚õàÔ∏è Storm damaged some of your lemons!",
                effect: {
                    spoilLemons: 3
                }
            },
            {
                text: "üéÅ A friend gives you free lemons!",
                effect: {
                    freeLemons: 5
                }
            },
            {
                text: "üêõ Bugs got into your storage! Lost some lemons.",
                effect: {
                    spoilLemons: 2
                }
            },
            {
                text: "üöõ Wholesale delivery mistake - free lemons for you!",
                effect: {
                    freeLemons: 8
                }
            }
        ];

        // Screen Management
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        function showStartScreen() {
            showScreen('startScreen');
        }

        function showInstructions() {
            showScreen('instructionsScreen');
        }

        function startGame() {
            resetGameState();
            updateDisplay();
            showTodayVocabulary();
            showScreen('gameScreen');

            // Random chance for event on first day
            if (Math.random() < 0.3) {
                setTimeout(() => showRandomEvent(), 1000);
            }
        }

        function resetGame() {
            resetGameState();
            showStartScreen();
        }

        function resetGameState() {
            gameState = {
                money: 50,
                inventory: 0,
                day: 1,
                revenue: 0,
                costs: 0,
                advertising: 0,
                upgrades: [],
                learnedWords: new Set(),
                actionsLeft: 8,
                lemonBatches: [],
                totalCustomersServed: 0,
                bestProfitDay: 0,
                dailyProfits: [],
                lemonBuyPrice: 2,
                lemonSellPrice: 3,
                spoiledLemons: 0,
                hasLoan: false,
                loanAmount: 0,
                dailyTransactions: {
                    sales: [],
                    purchases: [],
                    expenses: [],
                    spoilage: 0
                }
            };
        }

        // Display Updates
        function updateDisplay() {
            // FORMAT: Always display money with exactly 2 decimal places to avoid floating-point display issues
            document.getElementById('moneyDisplay').textContent = `$${gameState.money.toFixed(2)}`;
            document.getElementById('inventoryDisplay').textContent = gameState.inventory;
            document.getElementById('dayDisplay').textContent = gameState.day;
            document.getElementById('levelDisplay').textContent = getBusinessLevel();
            document.getElementById('actionsDisplay').textContent = gameState.actionsLeft;

            // Update market news
            updateMarketNews();

            // Check for bankruptcy
            if (gameState.money <= 0 && gameState.inventory === 0 && !gameState.hasLoan) {
                setTimeout(() => showModal('bankruptcyModal'), 500);
            }
        }

        function getBusinessLevel() {
            if (gameState.money >= 200) return "Tycoon";
            if (gameState.money >= 150) return "Big Store";
            if (gameState.money >= 100) return "Small Shop";
            return "Beginner";
        }

        function showTodayVocabulary() {
            const todayWords = getRandomWords(3);
            const vocabContainer = document.getElementById('todayVocab');
            vocabContainer.innerHTML = '';

            todayWords.forEach(word => {
                const wordElement = document.createElement('div');
                wordElement.className = 'vocab-word';
                wordElement.textContent = word;
                vocabContainer.appendChild(wordElement);
                gameState.learnedWords.add(word);
            });
        }

        function getRandomWords(count) {
            const shuffled = [...businessVocabulary].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        }

        function updateMarketNews() {
            const newsTexts = [
                // FORMAT: Display lemon prices with 2 decimal places for consistency
                `üçã Lemon prices: Buy $${gameState.lemonBuyPrice.toFixed(2)} each, Sell $${gameState.lemonSellPrice.toFixed(2)} each`,
                `üìà Market is ${gameState.lemonBuyPrice < 2 ? 'favorable' : 'challenging'} for buyers today`,
                `üí∞ ${gameState.lemonSellPrice > 3 ? 'High demand' : 'Normal demand'} for lemonade in the city`
            ];
            document.getElementById('marketNewsText').textContent = newsTexts[Math.floor(Math.random() * newsTexts
                .length)];
        }

        function updatePrices() {
            // Fluctuate prices daily within reasonable ranges
            gameState.lemonBuyPrice = Math.max(1, Math.min(4, gameState.lemonBuyPrice + (Math.random() - 0.5) * 1));
            gameState.lemonSellPrice = Math.max(2, Math.min(5, gameState.lemonSellPrice + (Math.random() - 0.5) * 1));
            gameState.lemonBuyPrice = Math.round(gameState.lemonBuyPrice * 100) / 100;
            gameState.lemonSellPrice = Math.round(gameState.lemonSellPrice * 100) / 100;
        }

        function checkSpoilage() {
            let spoiled = 0;
            gameState.lemonBatches = gameState.lemonBatches.filter(batch => {
                const age = gameState.day - batch.day;
                if (age >= 3) {
                    spoiled += batch.amount;
                    return false;
                }
                return true;
            });

            // FIX: Only subtract spoiled lemons from current inventory, don't recalculate from batches
            // This prevents inventory from being incorrectly reset to batch totals
            gameState.inventory = Math.max(0, gameState.inventory - spoiled);
            gameState.spoiledLemons = spoiled;
            return spoiled;
        }

        function useAction() {
            gameState.actionsLeft--;
            updateDisplay();

            if (gameState.actionsLeft <= 0) {
                setTimeout(() => {
                    alert("‚è∞ No more actions left today! Day ending automatically.");
                    endDay();
                }, 500);
            }
        }

        // TRANSACTION TRACKING FUNCTIONS - Ensures accurate day summary calculations
        function recordSale(quantity, price) {
            const revenue = quantity * price;
            gameState.dailyTransactions.sales.push({
                quantity: quantity,
                price: price,
                revenue: revenue
            });
        }

        function recordPurchase(quantity, cost) {
            gameState.dailyTransactions.purchases.push({
                quantity: quantity,
                cost: cost
            });
        }

        function recordExpense(type, amount) {
            gameState.dailyTransactions.expenses.push({
                type: type,
                amount: amount
            });
        }

        function recordSpoilage(quantity) {
            gameState.dailyTransactions.spoilage += quantity;
        }

        function calculateDaySummary() {
            // Calculate totals from transaction log (single source of truth)
            const totalRevenue = gameState.dailyTransactions.sales.reduce((sum, sale) => sum + sale.revenue, 0);
            const totalPurchaseCosts = gameState.dailyTransactions.purchases.reduce((sum, purchase) => sum + purchase
                .cost, 0);
            const totalExpenses = gameState.dailyTransactions.expenses.reduce((sum, expense) => sum + expense.amount,
            0);
            const totalCosts = totalPurchaseCosts + totalExpenses;
            const totalProfit = totalRevenue - totalCosts;
            const totalCustomers = gameState.dailyTransactions.sales.reduce((sum, sale) => sum + sale.quantity, 0);

            return {
                revenue: totalRevenue,
                costs: totalCosts,
                profit: totalProfit,
                customers: totalCustomers,
                spoilage: gameState.dailyTransactions.spoilage
            };
        }

        function resetDailyTransactions() {
            gameState.dailyTransactions = {
                sales: [],
                purchases: [],
                expenses: [],
                spoilage: 0
            };
        }

        function takeLoan() {
            gameState.money += 30;
            gameState.hasLoan = true;
            gameState.loanAmount = 30;
            closeModal('bankruptcyModal');
            updateDisplay();
            // FORMAT: Display loan amounts with proper decimal formatting
            alert("üè¶ Loan approved! You received $30.00. Remember: $5.00 interest per day!");
        }

        function declareBankruptcy() {
            closeModal('bankruptcyModal');
            alert("üíî Game Over! You declared bankruptcy. Better luck next time!");
            showFinalResults();
        }

        // Modal Management
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showBuyModal() {
            if (gameState.actionsLeft <= 0) {
                alert("‚è∞ No actions left today!");
                return;
            }

            const minCost = gameState.lemonBuyPrice * 5;
            if (gameState.money < minCost) {
                // FORMAT: Display minimum cost with 2 decimal places in alert message
                alert(`üí∏ Not enough money to buy supplies! You need at least $${minCost.toFixed(2)}.`);
                return;
            }

            // Update buy options with current prices
            const buyOptions = document.getElementById('buyOptions');
            // FORMAT: Calculate prices with full precision, but format display to 2 decimal places
            const price5 = gameState.lemonBuyPrice * 5;
            const price10 = gameState.lemonBuyPrice * 10;
            const price20 = gameState.lemonBuyPrice * 20;

            buyOptions.innerHTML = `
                <button class="option-btn" onclick="buySupplies(5, ${price5})">üçã 5 Lemons<br>$${price5.toFixed(2)}</button>
                <button class="option-btn" onclick="buySupplies(10, ${price10})">üçã 10 Lemons<br>$${price10.toFixed(2)}</button>
                <button class="option-btn" onclick="buySupplies(20, ${price20})">üçã 20 Lemons<br>$${price20.toFixed(2)}</button>
            `;

            showModal('buyModal');
        }

        function showSellModal() {
            if (gameState.actionsLeft <= 0) {
                alert("‚è∞ No actions left today!");
                return;
            }
            if (gameState.inventory === 0) {
                alert("üì¶ No inventory to sell! Buy supplies first.");
                return;
            }
            showModal('sellModal');
        }

        function showAdvertiseModal() {
            if (gameState.actionsLeft <= 0) {
                alert("‚è∞ No actions left today!");
                return;
            }
            if (gameState.money < 5) {
                alert("üí∏ Not enough money to advertise!");
                return;
            }
            showModal('advertiseModal');
        }

        function showUpgradeModal() {
            if (gameState.actionsLeft <= 0) {
                alert("‚è∞ No actions left today!");
                return;
            }
            if (gameState.money < 20) {
                alert("üí∏ Not enough money for upgrades!");
                return;
            }
            showModal('upgradeModal');
        }

        // Game Actions
        function buySupplies(amount, cost) {
            if (gameState.money >= cost) {
                gameState.money -= cost;
                gameState.inventory += amount;

                // Record transaction for accurate day summary
                recordPurchase(amount, cost);

                // Add to lemon batches with purchase date
                gameState.lemonBatches.push({
                    amount: amount,
                    day: gameState.day
                });

                useAction();
                closeModal('buyModal');
                // FORMAT: Display purchase cost with 2 decimal places in success message
                alert(`‚úÖ Bought ${amount} lemons for $${cost.toFixed(2)}!`);
            } else {
                alert("üí∏ Not enough money!");
            }
        }

        function sellProducts(price) {
            if (gameState.inventory === 0) {
                alert("üì¶ No inventory to sell!");
                return;
            }

            // Calculate customers based on price and advertising
            let baseCustomers = Math.floor(Math.random() * 10) + 5;
            let customerMultiplier = 1;

            // Price affects customers
            if (price === 1) customerMultiplier = 1.5; // Cheap attracts more
            if (price === 3) customerMultiplier = 0.7; // Expensive attracts fewer

            // Advertising bonus
            customerMultiplier += gameState.advertising * 0.2;

            // Apply event effects
            if (window.currentEventEffect && window.currentEventEffect.customers) {
                customerMultiplier *= window.currentEventEffect.customers;
            }

            const customers = Math.floor(baseCustomers * customerMultiplier);
            const sold = Math.min(customers, gameState.inventory);
            const revenue = sold * price;

            // Update inventory and money
            gameState.inventory -= sold;
            gameState.money += revenue;

            // FIX: Update lemon batches to reflect sold inventory (FIFO - First In, First Out)
            // This ensures batch tracking stays synchronized with actual inventory
            let remainingToSell = sold;
            gameState.lemonBatches = gameState.lemonBatches.filter(batch => {
                if (remainingToSell <= 0) return true;

                if (batch.amount <= remainingToSell) {
                    remainingToSell -= batch.amount;
                    return false; // Remove this batch completely
                } else {
                    batch.amount -= remainingToSell;
                    remainingToSell = 0;
                    return true; // Keep this batch with reduced amount
                }
            });

            // Record transaction for accurate day summary
            recordSale(sold, price);

            // Update total customers served
            gameState.totalCustomersServed += sold;

            useAction();
            updateDisplay();
            closeModal('sellModal');
            // FORMAT: Display price and revenue with proper decimal formatting
            alert(`üéâ Sold ${sold} lemonades for $${price.toFixed(2)} each! Made $${revenue.toFixed(2)}!`);
        }

        function advertise(type, cost) {
            // Check for free advertising event
            if (window.currentEventEffect && window.currentEventEffect.freeAd) {
                cost = 0;
            }

            if (gameState.money >= cost) {
                gameState.money -= cost;
                gameState.advertising += 1;

                // Record expense for accurate day summary
                if (cost > 0) {
                    recordExpense('advertising', cost);
                }

                useAction();
                updateDisplay();
                closeModal('advertiseModal');

                const messages = {
                    'flyers': `üìÑ Put up flyers around town! More customers will come.`,
                    'signs': `ü™ß Made colorful signs! Your shop looks great!`,
                    'social': `üì± Posted on social media! Going viral!`
                };

                // FORMAT: Display advertising cost with 2 decimal places when not free
                alert(`‚úÖ ${messages[type]} ${cost === 0 ? '(Free today!)' : `Cost: $${cost.toFixed(2)}`}`);
            } else {
                alert("üí∏ Not enough money!");
            }
        }

        function upgrade(type, cost) {
            if (gameState.money >= cost && !gameState.upgrades.includes(type)) {
                gameState.money -= cost;
                gameState.upgrades.push(type);

                // Record expense for accurate day summary
                recordExpense('upgrade', cost);

                useAction();
                updateDisplay();
                closeModal('upgradeModal');

                const messages = {
                    'table': `ü™ë Got a better table! Customers are happier!`,
                    'sign': `ü™ß Fancy new sign attracts more customers!`,
                    'location': `üè™ Moved to a better location! Premium spot!`
                };

                // FORMAT: Display upgrade cost with 2 decimal places
                alert(`‚úÖ ${messages[type]} Cost: $${cost.toFixed(2)}`);
            } else if (gameState.upgrades.includes(type)) {
                alert("‚úÖ You already have this upgrade!");
            } else {
                alert("üí∏ Not enough money!");
            }
        }

        function showRandomEvent() {
            const event = randomEvents[Math.floor(Math.random() * randomEvents.length)];
            document.getElementById('eventText').textContent = event.text;

            // Apply event effects
            window.currentEventEffect = event.effect;
            if (event.effect.money) {
                gameState.money += event.effect.money;
                updateDisplay();
            }

            showModal('eventModal');
        }

        function endDay() {
            // Calculate accurate daily summary from transaction log
            const summary = calculateDaySummary();

            // Display calculated values with proper formatting
            document.getElementById('revenueDisplay').textContent = `$${summary.revenue.toFixed(2)}`;
            document.getElementById('costsDisplay').textContent = `$${summary.costs.toFixed(2)}`;
            document.getElementById('profitDisplay').textContent = `$${summary.profit.toFixed(2)}`;
            document.getElementById('customersDisplay').textContent = summary.customers;

            // Show spoilage alert if any lemons spoiled
            if (summary.spoilage > 0) {
                document.getElementById('spoilageAlert').style.display = 'block';
                document.getElementById('spoilageText').textContent = `${summary.spoilage} lemons spoiled today!`;
            } else {
                document.getElementById('spoilageAlert').style.display = 'none';
            }

            // Track best profit day for achievements
            if (summary.profit > gameState.bestProfitDay) {
                gameState.bestProfitDay = summary.profit;
            }
            gameState.dailyProfits.push(summary.profit);

            // Show learned vocabulary
            const learnedContainer = document.getElementById('learnedVocab');
            learnedContainer.innerHTML = '';
            const todayWords = document.querySelectorAll('#todayVocab .vocab-word');
            todayWords.forEach(wordEl => {
                const newWordEl = wordEl.cloneNode(true);
                learnedContainer.appendChild(newWordEl);
            });

            showScreen('dayEndScreen');
        }

        // FIX: Add inventory validation function to ensure consistency
        function validateInventory() {
            // Ensure inventory matches the sum of all lemon batches
            const batchTotal = gameState.lemonBatches.reduce((total, batch) => total + batch.amount, 0);
            if (gameState.inventory !== batchTotal) {
                console.warn(`Inventory mismatch detected: inventory=${gameState.inventory}, batches=${batchTotal}`);
                // Use the actual inventory count as the source of truth
                // Don't automatically "fix" it as this could mask other bugs
            }
        }

        function nextDay() {
            // FIX: Validate inventory consistency before processing new day
            validateInventory();

            // Process spoilage and loan interest before starting new day
            const spoiled = checkSpoilage();
            if (spoiled > 0) {
                recordSpoilage(spoiled);
            }

            // Apply loan interest
            if (gameState.hasLoan) {
                gameState.money -= 5;
                recordExpense('loan interest', 5);
            }

            // Update prices for new day
            updatePrices();

            // Reset for new day
            gameState.day++;
            gameState.actionsLeft = 8;
            gameState.advertising = Math.max(0, gameState.advertising - 1); // Advertising effect decreases
            window.currentEventEffect = null; // Reset event effects

            // Reset daily transactions for new day
            resetDailyTransactions();

            // FIX: Ensure inventory persists correctly - no automatic restocking
            // The inventory should remain exactly as it was at the end of the previous day
            // (minus any spoilage that was already processed above)

            if (gameState.day > 10) {
                showFinalResults();
            } else {
                updateDisplay();
                showTodayVocabulary();
                showScreen('gameScreen');

                // Random chance for event
                if (Math.random() < 0.4) {
                    setTimeout(() => showRandomEvent(), 1000);
                }
            }
        }

        function showFinalResults() {
            // FORMAT: Display final money with exactly 2 decimal places
            document.getElementById('finalMoney').textContent = `$${gameState.money.toFixed(2)}`;
            document.getElementById('businessLevel').textContent = getBusinessLevel();
            document.getElementById('totalWords').textContent = gameState.learnedWords.size;
            document.getElementById('totalCustomers').textContent = gameState.totalCustomersServed;

            // Calculate and display achievements
            displayAchievements();

            // Update shop visual based on final level
            const level = getBusinessLevel();
            const shopEmojis = {
                'Beginner': 'üè™',
                'Small Shop': 'üè¨',
                'Big Store': 'üè¢',
                'Tycoon': 'üè∞'
            };
            document.getElementById('finalShopLevel').textContent = shopEmojis[level];

            showScreen('resultsScreen');
        }

        function displayAchievements() {
            const achievementsGrid = document.getElementById('achievementsGrid');
            achievementsGrid.innerHTML = '';

            const achievements = [];

            // Money achievements
            // FORMAT: Display achievement money amounts with 2 decimal places
            if (gameState.money >= 200) {
                achievements.push({
                    icon: 'üí∞',
                    title: 'Money Master',
                    desc: `Ended with $${gameState.money.toFixed(2)}`
                });
            } else if (gameState.money >= 100) {
                achievements.push({
                    icon: 'üíµ',
                    title: 'Good Saver',
                    desc: `Ended with $${gameState.money.toFixed(2)}`
                });
            }

            // Customer achievements
            if (gameState.totalCustomersServed >= 100) {
                achievements.push({
                    icon: 'üë•',
                    title: 'People Person',
                    desc: `Served ${gameState.totalCustomersServed} customers`
                });
            } else if (gameState.totalCustomersServed >= 50) {
                achievements.push({
                    icon: 'ü§ù',
                    title: 'Customer Friend',
                    desc: `Served ${gameState.totalCustomersServed} customers`
                });
            }

            // Profit achievements
            if (gameState.bestProfitDay >= 50) {
                achievements.push({
                    icon: 'üìà',
                    title: 'Profit King',
                    desc: `Best day: $${gameState.bestProfitDay.toFixed(2)} profit`
                });
            } else if (gameState.bestProfitDay >= 20) {
                achievements.push({
                    icon: 'üìä',
                    title: 'Smart Trader',
                    desc: `Best day: $${gameState.bestProfitDay.toFixed(2)} profit`
                });
            }

            // Learning achievement
            if (gameState.learnedWords.size >= 20) {
                achievements.push({
                    icon: 'üéì',
                    title: 'Word Wizard',
                    desc: `Learned ${gameState.learnedWords.size} business words`
                });
            }

            // Default participation achievement
            if (achievements.length === 0) {
                achievements.push({
                    icon: '‚≠ê',
                    title: 'Great Effort',
                    desc: 'Completed the business challenge!'
                });
            }

            achievements.forEach(achievement => {
                const badge = document.createElement('div');
                badge.className = 'achievement-badge';
                badge.innerHTML = `
                    <div class="badge-icon">${achievement.icon}</div>
                    <div class="badge-title">${achievement.title}</div>
                    <div class="badge-desc">${achievement.desc}</div>
                `;
                achievementsGrid.appendChild(badge);
            });
        }

        // Close modals when clicking outside
        window.onclick = function (event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // Initialize game
        updateDisplay();
    </script>

</body>

</html>